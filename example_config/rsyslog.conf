#  /etc/rsyslog.conf	Configuration file for rsyslog.
#
#			For more information see
#			/usr/share/doc/rsyslog-doc/html/rsyslog_conf.html
#
#  Default logging rules can be found in /etc/rsyslog.d/50-default.conf


#################
#### MODULES ####
#################

module(load="imuxsock") # provides support for local system logging
module(load="imklog")   # provides kernel logging support
# ============= ELK ===================
module(load="omelasticsearch")
template(name="temp1" type="list" option.json="on") {
           constant(value="{")
             constant(value="\"timestamp\":\"")      property(name="timereported" dateFormat="rfc3339")
             constant(value="\",\"message\":\"")     property(name="msg")
             constant(value="\",\"host\":\"")        property(name="hostname")
             constant(value="\",\"severity\":\"")    property(name="syslogseverity-text")
             constant(value="\",\"facility\":\"")    property(name="syslogfacility-text")
             constant(value="\",\"syslogtag\":\"")   property(name="syslogtag")
           constant(value="\"}")
}
action(type="omelasticsearch"
       server="http://10.0.4.10"
       serverport="9200"
       template="temp1"
       searchIndex="test-index"
       searchType="test-type"
       bulkmode="on"
       maxbytes="100m"
       queue.type="linkedlist"
       queue.size="5000"
       queue.dequeuebatchsize="300"
       action.resumeretrycount="-1")
# ==================== GELF
template(name="gelf" type="list") {
    constant(value="{\"version\":\"1.1\",")
    constant(value="\"host\":\"")
    property(name="hostname")
    constant(value="\",\"container_name\":\"")
    property(name="app-name" format="json")
    constant(value="\",\"short_message\":\"")
    property(name="msg" format="json")
    constant(value="\",\"timestamp\":")
    property(name="timereported" dateformat="unixtimestamp")
    constant(value=",\"level\":\"")
    property(name="syslogseverity")
    constant(value="\"}")
}
action(type="omfwd" target="10.0.4.10" port="12201" protocol="tcp" template="gelf" TCP_FrameDelimiter="0" KeepAlive="on")
# ====== RAW file
template(name="AAtmp" type="string" string="/var/log/AAA/%app-name%.log")
action(type="omfile" dynaFile="AAtmp")

# ====== JSON file
#template(name="tmptmp" type="list" json.option="on") {
  
# # constant(value="{")
#  property(outname="msg:" name="msg" format="jsonf")
# # constant(value="\n")
#  property(outname="rawmsg" name="rawmsg" format="jsonf")
# # constant(value="\n")
#  property(outname="rawmsg-after-pri:" name="rawmsg-after-pri" format="jsonf")
# # constant(value="\n")
#  property(outname="hostname:" name="hostname" format="jsonf")
# # constant(value="\n")
#  property(outname="source:" name="source" format="jsonf")
# # constant(value="\n")
#  property(outname="fromhost:" name="fromhost" format="jsonf")
# # constant(value="\n")
#  property(outname="fromhost-ip:" name="fromhost-ip" format="jsonf")
# # constant(value="\n")
#  property(outname="syslogtag:" name="syslogtag" format="jsonf")
# # constant(value="\n")
#  property(outname="programname:" name="programname" format="jsonf")
# # constant(value="\n")
#  property(outname="pri:" name="pri" format="jsonf")
# # constant(value="\n")
#  property(outname="pri-text:" name="pri-text" format="jsonf")
# # constant(value="\n")
#  property(outname="iut:" name="iut" format="jsonf")
# # constant(value="\n")
#  property(outname="syslogfacility:" name="syslogfacility" format="jsonf")
# # constant(value="\n")
#  property(outname="timereported:" name="timereported" format="jsonf")
# # constant(value="\n")
#  property(outname="structured-data:" name="structured-data" format="jsonf")
# # constant(value="\n")
#  property(outname="app-name:" name="app-name" format="jsonf")
# # constant(value="\n")
#  property(outname="procid:" name="procid" format="jsonf")
# # constant(value="\n")
#  property(outname="msgid:" name="msgid" format="jsonf")
# # constant(value="\n")
#  property(outname="inputname:" name="inputname" format="jsonf")
# # constant(value="\n")
#  property(outname="jsonmesg:" name="jsonmesg" format="jsonf")
# # constant(value="\n")
# # property(outname=":" name="" format="jsonf")
# # constant(value="\n")
# # property(outname=":" name="" format="jsonf")
# # constant(value="\n")
# # property(outname=":" name="" format="jsonf")
#  constant(value="\n")
# # constant(value="}\n")
}
# =====================================================
#set $!usr!tpl2!msg = $msg;
#set $!usr!tpl2!dataflow = field($msg, 58, 2);
#template(name="tpl2" type="subtree" subtree="$!usr!tpl2")
#action(type="omfile" File="/home/msqadmin/BBB" template="tpl2")

# ======================

#module(load="imdocker")
#template (name="ImdockerFormat" type="string"
#      string="program:%programname% tag:%syslogtag% id:%$!metadata!Id% name:%$!metadata!Names% imageid:%$!metadata!ImageID% labels:%$!metadata!Labels% msg: %msg%\n"
#)
#action(type="omfile" file="/var/log/DOCKER.log" template="ImdockerFormat")


# provides UDP syslog reception
#module(load="imudp")
#input(type="imudp" port="514")

## provides TCP syslog reception
#module(load="imtcp")
#input(type="imtcp" port="514")
#template(name="json-template"
#  type="list") {
#
#    constant(value="{")
#      constant(value="\"@timestamp\":\"")     property(name="timereported" dateFormat="rfc3339")
#      constant(value="\",\"@version\":\"1")
#      constant(value="\",\"message\":\"")     property(name="msg" format="json")
#      constant(value="\",\"sysloghost\":\"")  property(name="hostname")
#      constant(value="\",\"severity\":\"")    property(name="syslogseverity-text")
#      constant(value="\",\"facility\":\"")    property(name="syslogfacility-text")
#      constant(value="\",\"programname\":\"") property(name="programname")
#      constant(value="\",\"procid\":\"")      property(name="procid")
#    constant(value="\"}\n")
#}
#if ($msg contains "DOCKER") then {
#   action(type="omfile" file="/var/log/important.log" template="json-template")
#}
# Enable non-kernel facility klog messages
#$KLogPermitNonKernelFacility on

###########################
#### GLOBAL DIRECTIVES ####
###########################

#
# Use traditional timestamp format.
# To enable high precision timestamps, comment out the following line.
#
$ActionFileDefaultTemplate RSYSLOG_TraditionalFileFormat

# Filter duplicated messages
$RepeatedMsgReduction on

#
# Set the default permissions for all log files.
#
$FileOwner syslog
$FileGroup adm
$FileCreateMode 0640
$DirCreateMode 0755
$Umask 0022
$PrivDropToUser syslog
$PrivDropToGroup syslog

#
# Where to place spool and state files
#
$WorkDirectory /var/spool/rsyslog

#
# Include all config files in /etc/rsyslog.d/
#
$IncludeConfig /etc/rsyslog.d/*.conf

